  {{- /* ---------------------------------------------------------------
      REQUIRED ITEMS
      Note these are vars that have no default value in values.yaml
---------------------------------------------------------------------- */ -}}
{{ $_ := required "image.repository is REQUIRED!" .Values.image.repository }}
{{ $_ := required "image.tag is REQUIRED!" .Values.image.tag }}
{{ $_ := required "app.name is REQUIRED!" .Values.app.name }}
{{ $_ := required "app.context is REQUIRED!" .Values.app.context }}
{{ $_ := required "app.environment is REQUIRED!" .Values.app.environment }}
{{ $_ := required "healthcheck.liveness.containerPort is REQUIRED!" .Values.healthcheck.liveness.containerPort }}
{{ $_ := required "healthcheck.readiness.containerPort is REQUIRED!" .Values.healthcheck.readiness.containerPort }}

{{ if .Values.bootstrapSecret.enabled }}
  {{ $_ := required "bootstrapSecret.k8Secret.secretValue is REQUIRED!" .Values.bootstrapSecret.k8Secret.secretValue }}
{{- end }}

{{- /* ---------------------------------------------------------------
      VARIABLE/SETUP Auto Generated vars
---------------------------------------------------------------------- */}}
{{- $_ := set . "bootstrapSecretFilePath" (printf "%s/%s" .Values.bootstrapSecret.mount.path .Values.bootstrapSecret.mount.fileName) -}}
{{- $_ := set . "k8sSafeName_imageTag" (.Values.image.tag | replace "." "-") -}}


{{- define "shortener.tpl" }}
{{- $full :=  . -}}
{{- $short :=  $full | replace "-" "_" | replace "." "_" | camelcase -}}
{{- $hash :=  $full | adler32sum -}}
{{- $final :=  (gt (len $full) 63) | ternary $short $full -}}
{{- $final :=  (gt (len $final) 63) | ternary $hash $final -}}
{{- $final -}}
{{- end }}

{{- /* ---------------------------------------------------------------

  fullAppIdentifier

 This is annoying, due to lack of reliable ternary operators and nested IF garbage
 in golang conditionals and variable scope, we have no scratch like key-resolver...
 helm uses http://masterminds.github.io/sprig under the covers nicely.

--------------------------------------------------------------- */}}
{{- $tmpFullAppId := printf "%s-%s-%s-%sREMOVEME" (tpl .Values.app.shortName .) .Values.app.context .k8sSafeName_imageTag .Values.app.classifier -}}
{{- $tmpFullAppId := $tmpFullAppId | replace "-REMOVEME" "" -}}
{{- $tmpFullAppId := $tmpFullAppId | replace "REMOVEME" "" -}}
{{- $tmpFullAppId := $tmpFullAppId | replace "-%!s(<nil>)" "" -}}
{{ $_ :=  set . "fullAppIdentifier_full" $tmpFullAppId }}
{{ $_ :=  set . "fullAppIdentifier_short" ($tmpFullAppId | replace "-" "_" | replace "." "_" | camelcase) }}
{{ $_ :=  set . "fullAppIdentifier_hash" ($tmpFullAppId | adler32sum) }}
{{ $_ :=  set . "fullAppIdentifier" ((gt (len .fullAppIdentifier_full) 63) | ternary .fullAppIdentifier_short .fullAppIdentifier_full)}}
{{ $_ :=  set . "fullAppIdentifier" ((gt (len .fullAppIdentifier) 63) | ternary (printf "%s-%s-%s" .Values.app.name .Values.app.context .fullAppIdentifier_hash) .fullAppIdentifier)}}


{{- /* ---------------------------------------------------------------
      bootstrapSecretName
--------------------------------------------------------------- */}}
{{- $_ := set . "bootstrapSecretName" (printf "bootstrapsecret-%s" .fullAppIdentifier) -}}


{{- /* ---------------------------------------------------------------
  serviceAccountName
--------------------------------------------------------------- */}}
{{- $_ := set . "serviceAccountName" (tpl .Values.serviceAccount.name .) -}}


{{- /* ---------------------------------------------------------------
      Standard Labels TEMPLATE
      Usage {{ include "stdlabels.tpl" $stdlabelsargs | indent N }}
--------------------------------------------------------------- */}}
{{- $_ := set . "stdlabelsargs" (dict "root" $) }}

{{- define "stdlabels.tpl" }}
"{{ .root.Values.labelNames.appName }}": {{ .root.Values.app.name }}
"{{ .root.Values.labelNames.appContext }}": {{ .root.Values.app.context }}
"{{ .root.Values.labelNames.appEnvironment }}": {{ .root.Values.app.environment }}
"{{ .root.Values.labelNames.appVersion }}": {{ .root.Values.image.tag }}
"{{ .root.Values.labelNames.hashId }}": "{{ .root.fullAppIdentifier_hash }}"
{{ if .root.Values.app.classifier }}
"{{ .root.Values.labelNames.appClassifier }}": {{ .root.Values.app.classifier }}
{{ end }}
"{{ .root.Values.labelNames.creatorId }}": "{{ .root.Values.creatorId | replace "@" "_" }}"
"app.kubernetes.io/name": {{ .root.Values.app.name }}
"app.kubernetes.io/managed-by": {{ .root.Release.Service }}
"app.kubernetes.io/instance": {{ .root.fullAppIdentifier }}
"app.kubernetes.io/version": {{ .root.Values.image.tag }}
"app.kubernetes.io/part-of": {{ .root.Values.app.name }}
"app.kubernetes.io/component": "app"
"helm.sh/chart": {{ .root.Chart.Name }}-{{ .root.Chart.Version }}
{{- end }}







{{- /* ---------------------------------------------------------------
      Version specific RBAC
---------------------------------------------------------------------- */}}
{{- if .Values.serviceAccount.create }}


{{ $serviceAccountNamespace := tpl .Values.serviceAccount.namespace . }}

---

apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ $.serviceAccountName }}
  namespace: {{ $serviceAccountNamespace }}

---

kind: {{ $.Values.serviceAccount.kind }}
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: {{ $serviceAccountNamespace }}
  name: {{ $.serviceAccountName }}
rules:
- apiGroups:
  {{ range $apigroup := $.Values.serviceAccount.apiGroups }}
    - "{{ $apigroup }}"
  {{ end }}
  resources:
  {{ range $resource := $.Values.serviceAccount.resources }}
    - "{{ $resource }}"
  {{ end }}
  verbs:
  {{ range $verb := $.Values.serviceAccount.verbs }}
    - "{{ $verb }}"
  {{ end }}

---

# ClusterRoleBinding | RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: {{ (eq $.Values.serviceAccount.kind "ClusterRole") | ternary "ClusterRoleBinding" "RoleBinding" }}
metadata:
  name: {{ $.serviceAccountName }}
  namespace: {{ $serviceAccountNamespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ $.serviceAccountName }}
  namespace: {{ $serviceAccountNamespace }}
subjects:
- kind: ServiceAccount
  name: {{ $.serviceAccountName }}
  namespace: {{ $serviceAccountNamespace }}

{{ end }}




{{- /* ---------------------------------------------------------------
      Version specific Bootstrap Secret
---------------------------------------------------------------------- */}}

{{ if .Values.bootstrapSecret.enabled }}
---
apiVersion: v1
kind: Secret
metadata:
  namespace: {{ .Release.Namespace }}
  name: {{ $.bootstrapSecretName }}
  labels:
    {{ include "stdlabels.tpl" $.stdlabelsargs | indent 4 }}
type: Opaque
stringData:
  {{ .Values.bootstrapSecret.k8Secret.valueKey }}: {{ .Values.bootstrapSecret.k8Secret.secretValue }}
{{ end }}

{{- /* ---------------------------------------------------------------
      Version specific Deployment object
---------------------------------------------------------------------- */}}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: {{ .Release.Namespace }}
  name: {{ $.fullAppIdentifier }}
  labels:
    {{ include "stdlabels.tpl" $.stdlabelsargs | indent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      "{{ .Values.labelNames.appName }}": {{ .Values.app.name }}
      "{{ .Values.labelNames.appContext }}": {{ .Values.app.context }}
      "{{ .Values.labelNames.appEnvironment }}": {{ .Values.app.environment }}
      "{{ .Values.labelNames.appVersion }}": {{ .Values.image.tag }}
      {{ if .Values.app.classifier }}
      "{{ .Values.labelNames.appClassifier }}": {{ .Values.app.classifier }}
      {{ end }}
  template:
    metadata:
      labels:
        "{{ .Values.labelNames.appName }}": {{ .Values.app.name }}
        "{{ .Values.labelNames.appContext }}": {{ .Values.app.context }}
        "{{ .Values.labelNames.appEnvironment }}": {{ .Values.app.environment }}
        "{{ .Values.labelNames.appVersion }}": {{ .Values.image.tag }}
        {{ if .Values.app.classifier }}
        "{{ .Values.labelNames.appClassifier }}": {{ .Values.app.classifier }}
        {{ end }}
        "{{ .Values.labelNames.creatorId }}": "{{ .Values.creatorId | replace "@" "_" }}"
        {{- range $label := .Values.deployment.template.labels }}
        "{{ $label.name }}": "{{ tpl $label.value $ }}"
        {{- end }}
        "app.kubernetes.io/name": {{ .Values.app.name }}
        "app.kubernetes.io/managed-by": {{ .Release.Service }}
        "app.kubernetes.io/instance": {{ $.fullAppIdentifier }}
        "app.kubernetes.io/version": {{ $.Values.image.tag }}
        "app.kubernetes.io/part-of": {{ .Values.app.name }}
        "app.kubernetes.io/component": "app"
        "helm.sh/chart": {{ .Chart.Name }}-{{ .Chart.Version }}
    spec:
      serviceAccountName: {{ $.serviceAccountName }}
      {{ if hasKey .Values "imagePullSecrets" }}
      imagePullSecrets:
        {{ range $secretName := .Values.imagePullSecrets }}
        - name: {{ $secretName }}
        {{ end }}
      {{ end }}
      volumes:
        {{ if .Values.bootstrapSecret.enabled }}
        - name: bootstrap-secret-volume
          secret:
            secretName: {{ $.bootstrapSecretName }}
            defaultMode: 256
            items:
              - key: {{ .Values.bootstrapSecret.k8Secret.valueKey }}
                path: {{ .Values.bootstrapSecret.mount.fileName }}
        {{ end }}
      containers:
        - name: {{ .Values.app.name }}
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          securityContext:
            {{ if hasKey .Values.securityContext "allowPrivilegeEscalation" }}
            allowPrivilegeEscalation: {{ .Values.securityContext.allowPrivilegeEscalation }}
            {{ end }}
            {{ if .Values.securityContext.runAsUser }}
            runAsUser: {{ .Values.securityContext.runAsUser }}
            {{ end }}
            {{ if .Values.securityContext.runAsGroup }}
            runAsGroup: {{ .Values.securityContext.runAsGroup }}
            {{ end }}
          volumeMounts:
            {{ if .Values.bootstrapSecret.enabled }}
            - name: bootstrap-secret-volume
              mountPath: "{{ .Values.bootstrapSecret.mount.path }}"
              readOnly: true
            {{ end }}
          ports:
            {{- range $containerPort := .Values.containerPorts }}
              {{- if $containerPort.classifiers }}
                {{- if has $.Values.app.classifier $containerPort.classifiers }}
            - containerPort: {{ $containerPort.port }}
                {{- end }}
              {{- else }}
            - containerPort: {{ $containerPort.port }}
              {{- end }}
            {{- end }}
          {{ if and .Values.resources }}
          resources:
            {{ if and .Values.resources.limits -}}
            limits:
              cpu: "{{ .Values.resources.limits.cpu }}"
            {{ end -}}
            {{ if and .Values.resources.requests -}}
            requests:
              cpu: "{{ .Values.resources.requests.cpu }}"
            {{ end -}}
          {{ end }}
          {{ if eq .Values.healthcheck.liveness.disabled "false" }}
          livenessProbe:
            httpGet:
              scheme: {{ .Values.healthcheck.liveness.scheme }}
              path: {{ .Values.healthcheck.liveness.path }}
              port: {{ .Values.healthcheck.liveness.containerPort }}
            initialDelaySeconds: {{ .Values.healthcheck.liveness.initialDelaySeconds }}
            periodSeconds: {{ .Values.healthcheck.liveness.periodSeconds }}
            timeoutSeconds: {{ .Values.healthcheck.liveness.timeoutSeconds }}
            failureThreshold: {{ .Values.healthcheck.liveness.failureThreshold }}
          {{ end }}
          {{ if eq .Values.healthcheck.readiness.disabled "false" }}
          readinessProbe:
            httpGet:
              scheme: {{ .Values.healthcheck.readiness.scheme }}
              path: {{ .Values.healthcheck.readiness.path }}
              port: {{ .Values.healthcheck.readiness.containerPort }}
            initialDelaySeconds: {{ .Values.healthcheck.readiness.initialDelaySeconds }}
            periodSeconds: {{ .Values.healthcheck.readiness.periodSeconds }}
            timeoutSeconds: {{ .Values.healthcheck.readiness.timeoutSeconds }}
            failureThreshold: {{ .Values.healthcheck.readiness.failureThreshold }}
          {{ end }}

          env:
            {{- range $key, $value := .Values.env }}
            - name: {{ $key }}
              {{- if and $value $value.value }}
              value: "{{ tpl $value.value $ }}"
              {{ else }}
              value: ""
              {{- end -}}
            {{- end }}

          {{ if .Values.command }}
          command: {{ .Values.command.command }}

          {{ if .Values.command.args }}
          args:
            {{- range $arg := .Values.command.preArgs }}
            - "{{ tpl $arg $ }}"
            {{- end }}

            {{- range $arg := .Values.command.args }}
            - "{{ tpl $arg $ }}"
            {{- end }}

            {{- range $arg := .Values.command.postArgs }}
            - "{{ tpl $arg $ }}"
            {{- end }}
          {{- end }}
          {{- end }}


{{- /* ---------------------------------------------------------------
      Version specific Service object
---------------------------------------------------------------------- */}}
---
apiVersion: v1
kind: Service
metadata:
  namespace: "{{ $.Release.Namespace }}"
  name: "{{ $.fullAppIdentifier }}"
  labels:
    {{ include "stdlabels.tpl" $.stdlabelsargs | indent 4 }}

    {{- range $label := .Values.service.labels }}
    "{{ $label.name }}": "{{ tpl $label.value $ }}"
    {{- end }}
spec:
  selector:
    "{{ .Values.labelNames.appName }}": {{ .Values.app.name }}
    "{{ .Values.labelNames.appContext }}": {{ .Values.app.context }}
    "{{ .Values.labelNames.appEnvironment }}": {{ .Values.app.environment }}
    "{{ .Values.labelNames.appVersion }}": {{ .Values.image.tag }}
    {{ if .Values.app.classifier }}
    "{{ .Values.labelNames.appClassifier }}": {{ .Values.app.classifier }}
    {{ end }}
  type: {{ .Values.service.type }}
  ports:
  {{- range $containerPort := .Values.containerPorts }}
    {{- if $containerPort.service }}
      {{- if $containerPort.classifiers }}
        {{- if has $.Values.app.classifier $containerPort.classifiers }}
  - protocol: TCP
    name: {{ $containerPort.name }}
    port: {{ $containerPort.port }}
    targetPort: {{ $containerPort.port }}
        {{ end -}}
      {{ else }}
  - protocol: TCP
    name: {{ $containerPort.name }}
    port: {{ $containerPort.port }}
    targetPort: {{ $containerPort.port }}
      {{ end -}}
    {{ end -}}
  {{- end }}






{{- /* ---------------------------------------------------------------
      default.validator.hooks (templates)
      What follows defines a embedded golang template
      that is invoked later at bottom of this file

      arg dict:
        "root" = $
        "objectIdentifier" = create all objects with this "name"
        "containerPort" = containerPort the igress is for
---------------------------------------------------------------------- */}}
{{- define "default.validator.hooks" }}

{{/* -------------------------------------
     HOOK Support: POST INSTALL UPGRADE ConfigMap
    (note this is part of the release but only
    here for the Job to consume, technically
    not a Hook due to lack of annotation)
------------------------------------------ */}}
  {{ if .root.Values.hooks.default.postInstallUpgrade.validator.enabled }}

  {{ $hookObjectName := printf "%s-%s-postdeploy-validator" .objectIdentifier .containerPort.port | replace "-" "" }}
---

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $hookObjectName }}
  namespace: "{{ .root.Release.Namespace }}"
  labels:
    {{ include "stdlabels.tpl" .root.stdlabelsargs | indent 4 }}
data:
  healthchecks.config.yaml: |
{{ toYaml .root.Values.hooks.default.postInstallUpgrade.validator.checksConfig | indent 4 }}
  slackalerts.config.yaml: |
{{ toYaml .root.Values.hooks.default.postInstallUpgrade.validator.slackConfig | indent 4 }}

{{/* -------------------------------------
     HOOK: POST INSTALL/UPGRADE Job
     (Checks health and alerts)
------------------------------------------ */}}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ $hookObjectName }}"
  namespace: "{{ .root.Release.Namespace }}"
  labels:
    {{ include "stdlabels.tpl" .root.stdlabelsargs | indent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": {{ .root.Values.hooks.default.postInstallUpgrade.validator.hookDeletePolicy }}
spec:
  backoffLimit: 0 # retry 0 times
  activeDeadlineSeconds: 300 # max run for 10 minutes (i.e. inclusive of retries)
  template:
    metadata:
      name: "{{ $hookObjectName }}"
    spec:
      restartPolicy: Never
      volumes:
        - name: config-volume
          configMap:
            name: {{ $hookObjectName }}
      containers:
        - name: {{ $hookObjectName }}
          image: "{{ .root.Values.hooks.default.postInstallUpgrade.validator.image }}"
          command:
            - "checker.py"
          args:
            - "--check-name"
            {{ if .root.Values.hooks.default.postInstallUpgrade.validator.useIngressHost }}
            - "{{ printf "%s-%s%s" .objectIdentifier (.containerPort.port | toString) .root.Values.ingress.dns.fqdnSuffix }}"
            {{ else }}
            - "{{ printf "%s.%s.svc.cluster.local:%s" .objectIdentifier .root.Release.Namespace (.containerPort.port | toString) }}"
            {{ end }}
            - "--target-root-url"
            {{ if .root.Values.hooks.default.postInstallUpgrade.validator.useIngressHost }}
            - "{{ .containerPort.tls | ternary "https" "http" }}://{{ printf "%s-%s%s" .objectIdentifier (.containerPort.port | toString) .root.Values.ingress.dns.fqdnSuffix }}"
            {{ else }}
            - "{{ .containerPort.tls | ternary "https" "http" }}://{{ printf "%s.%s.svc.cluster.local:%s" .objectIdentifier .root.Release.Namespace (.containerPort.port | toString) }}"
            {{ end }}
            - "--max-retries"
            - "{{ .root.Values.hooks.default.postInstallUpgrade.validator.maxRetries }}"
            - "--sleep-seconds"
            - "{{ .root.Values.hooks.default.postInstallUpgrade.validator.sleepSeconds }}"
            - "--any-check-fail-exit-code"
            - "1"
            - "--tags-qualifier"
            - "{{ .containerPort.port }}"
            - "--extra-slack-context-props"
            - "creatorId={{ .root.Values.creatorId }}"
            - "--checksdb-filename"
            - "/etc/hc-config/healthchecks.config.yaml"
            - "--slack-config-filename"
            - "/etc/hc-config/slackalerts.config.yaml"
            {{ if .root.Values.hooks.default.postInstallUpgrade.validator.debugOutput }}
            - "--verbose-output"
            - "--debug-slack-jinja2-context"
            {{ end }}
          volumeMounts:
            - name: config-volume
              mountPath: /etc/hc-config
  {{ end }}



{{/* -------------------------------------
     HOOK Support: POST DELETE ConfigMap
------------------------------------------ */}}
  {{ if .root.Values.hooks.default.postDelete.validator.enabled }}

    {{ $hookObjectName := printf "%s-%s-postdelete-validator" .objectIdentifier .containerPort.port | replace "-" "" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $hookObjectName }}
  namespace: "{{ .root.Release.Namespace }}"
  labels:
    {{ include "stdlabels.tpl" .root.stdlabelsargs | indent 4 }}
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": hook-failed,before-hook-creation
data:
  healthchecks.config.yaml: |
{{ toYaml .root.Values.hooks.default.postDelete.validator.checksConfig | indent 4 }}
  slackalerts.config.yaml: |
{{ toYaml .root.Values.hooks.default.postDelete.validator.slackConfig | indent 4 }}

{{/* -------------------------------------
     HOOK: POST DELETE Job

    (Checks health (i.e. expects 404) and notifies)
------------------------------------------ */}}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: "{{ $hookObjectName }}"
  namespace: "{{ .root.Release.Namespace }}"
  labels:
    {{ include "stdlabels.tpl" .root.stdlabelsargs | indent 4 }}
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "2"
    "helm.sh/hook-delete-policy": {{ .root.Values.hooks.default.postDelete.validator.hookDeletePolicy }}
spec:
  backoffLimit: 0 # retry 0 times
  activeDeadlineSeconds: 300 # max run for 10 minutes (i.e. inclusive of retries)
  template:
    metadata:
      name: "{{ $hookObjectName }}"
    spec:
      restartPolicy: Never
      volumes:
        - name: config-volume
          configMap:
            name: {{ $hookObjectName }}
      containers:
        - name: {{ $hookObjectName }}
          image: "{{ .root.Values.hooks.default.postDelete.validator.image }}"
          command:
            - "checker.py"
          args:
            - "--check-name"
            {{ if .root.Values.hooks.default.postInstallUpgrade.validator.useIngressHost }}
            - "{{ printf "%s-%s%s" .objectIdentifier (.containerPort.port | toString) .root.Values.ingress.dns.fqdnSuffix }}"
            {{ else }}
            - "{{ printf "%s.%s.svc.cluster.local:%s" .objectIdentifier .root.Release.Namespace (.containerPort.port | toString) }}"
            {{ end }}
            - "--target-root-url"
            {{ if .root.Values.hooks.default.postInstallUpgrade.validator.useIngressHost }}
            - "{{ .containerPort.tls | ternary "https" "http" }}://{{ printf "%s-%s%s" .objectIdentifier (.containerPort.port | toString) .root.Values.ingress.dns.fqdnSuffix }}"
            {{ else }}
            - "{{ .containerPort.tls | ternary "https" "http" }}://{{ printf "%s.%s.svc.cluster.local:%s" .objectIdentifier .root.Release.Namespace (.containerPort.port | toString) }}"
            {{ end }}
            - "--max-retries"
            - "{{ .root.Values.hooks.default.postDelete.validator.maxRetries }}"
            - "--sleep-seconds"
            - "{{ .root.Values.hooks.default.postDelete.validator.sleepSeconds }}"
            - "--any-check-fail-exit-code"
            - "1"
            - "--extra-slack-context-props"
            - "creatorId={{ .root.Values.creatorId }}"
            - "--checksdb-filename"
            - "/etc/hc-config/healthchecks.config.yaml"
            - "--slack-config-filename"
            - "/etc/hc-config/slackalerts.config.yaml"
            {{ if .root.Values.hooks.default.postDelete.validator.debugOutput }}
            - "--verbose-output"
            - "--debug-slack-jinja2-context"
            {{ end }}
          volumeMounts:
            - name: config-volume
              mountPath: /etc/hc-config
  {{ end }}
{{ end -}}






{{- /* ---------------------------------------------------------------
      Version Specific Ingress Object template

      What follows defines a embedded golang template
      that is invoked later at bottom of this file
      One for each unique container port

      arg dict:
        "root" = $
        "objectIdentifier" = create all objects with this "name"
        "containerPort" = containerPort the igress is for
---------------------------------------------------------------------- */}}
{{- define "ingress.template" }}

{{- $ingressFqdn := printf "%s-%s%s" .objectIdentifier (.containerPort.port | toString) .root.Values.ingress.dns.fqdnSuffix }}
---
# Version specific Ingress (one per port)
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  namespace: "{{ .root.Release.Namespace }}"
  name: "{{ $ingressFqdn }}"
  labels:
    {{ include "stdlabels.tpl" .root.stdlabelsargs | indent 4 }}

    {{ if .root.Values.ingress.metadata.labels }}
      {{- $root := .root }}
      {{- range $label := .root.Values.ingress.metadata.labels }}
    "{{ $label.name }}": "{{ tpl $label.value $root }}"
      {{- end }}
    {{ end }}
  annotations:
    {{ if eq .containerPort.tls true }}
    ingress.kubernetes.io/protocol: "https"
    {{ else }}
    ingress.kubernetes.io/protocol: "http"
    {{ end }}

    {{ if .root.Values.ingress.metadata.annotations }}
      {{- $root := .root }}
      {{- range $annotation := .root.Values.ingress.metadata.annotations }}
    "{{ $annotation.name }}": "{{ tpl $annotation.value $root }}"
      {{- end }}
    {{ end }}

spec:
  {{ if .root.Values.ingress.tls.enabled }}
  tls:
  - hosts:
    - {{ $ingressFqdn }}
    secretName: {{ .root.Values.ingress.tls.secretName }}
  {{ end }}
  rules:
  - host: {{ $ingressFqdn }}
    http:
      paths:
      - backend:
          serviceName: {{ .root.fullAppIdentifier }}
          servicePort: {{ .containerPort.port }}
{{ end -}}







{{- /* ---------------------------------------------------------------
      Version specific Ingress objects (one per port)
      This also generates the hooks.default (validators) to test each url
---------------------------------------------------------------------- */}}

{{- range $containerPort := .Values.containerPorts }}
  {{ $ingressTemplateArgs := dict "root" $ "objectIdentifier" $.fullAppIdentifier "containerPort" $containerPort }}
  {{- if and $containerPort.ingress $containerPort.service }}

    {{- /* -----------------------------------------------
          If a "classifier" is present we must verify that
           the containerPort.classifiers contain it to create
           and ingress/hook check for it
    ----------------------------------------------- */}}
    {{- if $containerPort.classifiers }}
      {{- if has $.Values.app.classifier $containerPort.classifiers }}
{{ template "ingress.template" $ingressTemplateArgs }}
{{ template "default.validator.hooks" $ingressTemplateArgs }}

        {{- /* FOR EACH ALIAS, we alter the 'objectIdentifier' key of the args
               and then render a new ingress w/ the alias as the name/fqdn/host */}}
        {{ range $alias := $.Values.aliases }}
          {{ $aliasedIngressTemplateArgs := set $ingressTemplateArgs "objectIdentifier" ($.fullAppIdentifier | replace $.Values.app.name $alias) }}
{{ template "ingress.template" $aliasedIngressTemplateArgs }}
        {{ end }}
      {{ end }}

    {{- /* -----------------------------------------------
        ... otherwise no classifier present so we don't care
    ----------------------------------------------- */}}
    {{ else }}
{{ template "ingress.template" $ingressTemplateArgs }}
{{ template "default.validator.hooks" $ingressTemplateArgs }}

      {{- /* FOR EACH ALIAS, we alter the 'objectIdentifier' key of the args
             and then render a new ingress w/ the alias as the name/fqdn/host */}}
      {{ range $alias := $.Values.aliases }}
        {{ $aliasedIngressTemplateArgs := set $ingressTemplateArgs "objectIdentifier" ($.fullAppIdentifier | replace $.Values.app.name $alias) }}
{{ template "ingress.template" $aliasedIngressTemplateArgs }}
      {{ end }}

    {{ end }}
  {{ end }}
{{ end }}
